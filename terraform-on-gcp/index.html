<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Basic infrastructure on Google Cloud Platform with Terraform</title>
  <meta name="description" content="Basic infrastructure on Google Cloud Platform with Terraform">
  <meta name="author" content="Stein Inge Morisbak">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="../css/reveal.min.css">
  <link rel="stylesheet" href="../lib/css/zenburn.css">
  <link rel="stylesheet" href="../css/theme/bekk.css" id="theme">
  <link rel="stylesheet" href="css/custom.css" id="custom">
  <script>
    document.write('<link rel="stylesheet" href="../css/print/' + (window.location.search.match(/print-pdf/gi) ? 'pdf' : 'paper') + '.css" type="text/css" media="print">');

  </script>
</head>

<body>
  <div class="reveal">
    <div class="slides">

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height 100%;">
        <h2>Introduction to:</h2>
        <h1>Provisioning basic infrastructure on Google Cloud Platform with Terraform</h1>
        <p>Config Management Camp 2018</p>
        <img width="252" height="235" src="../img/me_bart.png" alt="Stein Inge Morisbak" />
        <p style="font-size: 28px;"><a href="https://twitter.com/steinim">@steinim</a></p>
        <p style="font-size: 28px;"><a href="mailto:stein.inge.morisbak@BEKK.no">stein.inge.morisbak@BEKK.no</a></p>
        <aside class="notes">
          <ul>
            <li>I'm a programmer working at BEKK Consulting</li>
            <li>I'm also the founder of DevOps Norway Meetup and organizer of DevOpsDays Oslo.</li>
            <li>Currently I'm working as Tech Lead for the team developing all customer facing applications for the Norwegian Railways, NSB.</li>
          </ul>
        </aside>
      </section>

      <section data-background-image="../img/nsb_bg.jpg" style="width: 100%; height: 100%;">
        <h1>&nbsp;</h1>
        <p>&nbsp;</p>
        <img width="235" height="235" src="../img/nsb.png" alt="NSB">
        <img width="235" height="235" src="../img/terraform.png" alt="Terraform" style="background:none; border:none; box-shadow:none;">
        <img width="235" height="235" src="../img/aws.jpg" alt="AWS">
        <p style="font-size: 28px;">&nbsp;</p>
        <p style="font-size: 28px;">&nbsp;</p>
        <footer class="layer right">Image by <a href="https://commons.wikimedia.org/wiki/File:NSB_BMb_74501_1.jpg">MPW57</a> licensed by <a href="https://creativecommons.org/licenses/by/3.0/deed.en">CC BY 3.0</a></footer>
        <aside class="notes">
          <ul>
            <li>We're using Terraform extensively on that project, and we're using AWS</li>
            <li>I'm curious about everything cloud</li>
            <li>wanted to see if and how GCP differs when it comes to the basic principles of good infrastructure</li>
          </ul>
        </aside>
      </section>


      <!--<section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Disclaimer</h1>
        <div class="mb-wrap mb-style-3">
          <blockquote>
            <p>I’m not an expert! I barely know anything! Everyone will know I’m a fraud!</p>
          </blockquote>
          <div class="fragment layer">
            <p style="font-size: 28px; color: #35bdb2; font-weight: 700;">Psst… here’s a secret: You don’t have to be an expert!</p>
          </div>
          <div class="mb-attribution">
            <p class="mb-author">David Neal</p>
            <cite><a href="https://medium.com/@reverentgeek/5-essential-ingredients-for-an-awesome-tech-talk-2e5778b2cb5a">5 Essential Ingredients for an Awesome Tech Talk</a></cite>
          </div>
        </div>
      </section> -->

      <section data-background-image="../img/devs.jpg" style="width: 100%; height: 100%;">
        <div style="background-color: rgba(0, 0, 0, 0.4);">
          <h1>Why GCP?</h1>
          <ul>
            <li>Broaden my horizon</li>
            <li>Build competence</li>
            <li>Know what I'm talking about</li>
            <li>Have fun!</li>
          </ul>
        </div>
        <p style="font-size: 28px;">&nbsp;</p>
        <p style="font-size: 28px;">&nbsp;</p>
        <img src="../img/gcp.png" width="300px" style="float: left; background:none; border:none; box-shadow:none; position: absolute; top: 52%; left: -20%;">
        <aside class="notes">
          Competency groups in BEKK. Made a workshop. I'm interested in Cloud Platforms in general, and wanted to see what are the differences between e.g. AWS and GCP when you are trying to solve the same problem. Not saying that the architecture and technological choices are the best. I would prefer a PaaS platform, and for applications we have done that on our AWS project. Still we do have a basic setup for things like networking (nat, public/private subnets, routing tables, availability zones etc.
        </aside>
      </section>



      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1 class="layer">AWS Architecture to reproduce</h1>
        <img width="1198" src="img/aws_architecture.png">
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1 class="layer">GCP Architecture result</h1>
        <img width="1198" src="img/gcp_architecture.png">
        <aside class="notes">
          The architecture in GCP ended up like this. The two providers differ.
        </aside>
      </section>
      
      <!--

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Glossary</h1>
        <ul>
          <li>aws_security_group &asymp; google_compute_firewall</li>
          <li>EC2 &asymp; Compute Engine</li>
          <li>RDS &asymp; GC SQL</li>
          <li>ELB &asymp; GC LB</li>
        </ul>
      </section>
-->

      <section>
        <h1>Terraform</h1>
        <img width="300" src="../img/terraform.png" alt="Terraform" style="background:none; border:none; box-shadow:none;">
        <p style="font-size: 28px;">&nbsp;</p>
        <p style="font-size: 28px;">&nbsp;</p>
        <aside class="notes">
          <ul>
            <li>Terraform is a tool for creating, changing and versioning of infrastructure in a safe, automated and effective manner.</li>
            <li>Describe your infrastructure in code and generate an execution plan describing what Terraform will provision to reach the desired state.</li>
            <li>When you make changes, Terraform finds out what the change is and executes the change incrementally. </li>
          </ul>
        </aside>
      </section>

      <section>
        <h1>What does it do?</h1>
        <ul>
          <li class="fragment">Documents (infrastructure as code)</li>
          <li class="fragment">Plans (no surprises)</li>
          <li class="fragment">Graphs (parallelizes where possible)</li>
          <li class="fragment">Automates (takes the human out of the equation)</li>
          <li class="fragment">Provider/Cloud agnostic (sort of)</li>
        </ul>
        <p style="font-size: 28px;">&nbsp;</p>
        <p style="font-size: 28px;">&nbsp;</p>
        <img src="../img/terraform.png" width="300px" style="float: left; background:none; border:none; box-shadow:none; position: absolute; top: 52%; left: -20%;">
        <aside class="notes">
          <ul>
            <li>Infrastructure as code: documentation, sharing and reuse.</li>
            <li>Execution plans: Shows in detail what is to be executed. Avoid surprises.</li>
            <li>Resource graph: parallelizes where it can and respects dependencies.</li>
            <li>Automation: Automates everything</li>
            <li>Provider/Cloud agnostic: single tool with a single DSL. Config does differ from one provider to the next. So indeed there is no such thing as a single agnostic VPC or instance config that can be used to deploy a VPC or instance in both AWS and Azure at the same time. The infrastructure providers themselves are just way to different to be able to do such a thing.</li>
          </ul>
        </aside>
      </section>

      <section>
        <h1>Why use it?</h1>
        <ul>
          <li class="fragment">Repeatable</li>
          <li class="fragment">Testable</li>
          <li class="fragment">Predictable</li>
          <li class="fragment">Self-documenting</li>
        </ul>
        <p style="font-size: 28px;">&nbsp;</p>
        <p style="font-size: 28px;">&nbsp;</p>
        <img src="../img/terraform.png" width="300px" style="float: left; background:none; border:none; box-shadow:none; position: absolute; top: 52%; left: -20%;">
        <aside class="notes">
          <ul>
            <li>Infrastructure as code: documentation, sharing and reuse.</li>
            <li>Execution plans: Shows in detail what is to be executed. Avoid surprises.</li>
            <li>Resource graph: parallelizes where it can and respects dependencies.</li>
            <li>Automation: Automates everything</li>
            <li>Provider/Cloud agnostic: single tool with a single DSL. Config does differ from one provider to the next. So indeed there is no such thing as a single agnostic VPC or instance config that can be used to deploy a VPC or instance in both AWS and Azure at the same time. The infrastructure providers themselves are just way to different to be able to do such a thing.</li>
          </ul>
        </aside>
      </section>

      <section>
        <h1>Terraform Components</h1>
        <ul>
          <li class="fragment">Configurations (<code>*.tf</code>)</li>
          <li class="fragment">Providers (AWS, Google Cloud, Azure, DigitalOcean, OpenStack...)</li>
          <li class="fragment">Resources (building blocks) &rarr;
            <ul>provider specific</ul>
          </li>
          <li class="fragment">Variables (infrastructure as data)</li>
          <li class="fragment">Data sources (fetch or compute data)</li>
          <li class="fragment">Outputs (data "after the fact")</li>
          <li class="fragment">Modules (for reuseability)</li>
        </ul>
        <p style="font-size: 28px;">&nbsp;</p>
        <p style="font-size: 28px;">&nbsp;</p>
        <img src="../img/terraform.png" width="300px" style="float: left; background:none; border:none; box-shadow:none; position: absolute; top: 52%; left: -20%;">
        <aside class="notes">
          <ul>
            <li>Configurations: text file that contains the infrastructure resource definitions (.tf extension)</li>
            <li>Providers</li>
            <li>Resources</li>
            <li>Variables</li>
            <li>Data sources</li>
            <li>Outputs</li>
            <li>Modules</li>
          </ul>
        </aside>
      </section>

      <section data-background-image="../img/pagerduty.jpg" style="width: 100%; height: 100%;">
        <h1 class="layer">The juicy part</h1>
      </section>

      <section data-background-image="img/github_workshop.png" style="width: 100%; height: 100%;">
        <h2>&nbsp;</h2>
        <h3 class="layer"><a href="https://github.com/steinim/gcp-terrafrom-workshop">https://github.com/steinim/gcp-terraform-workshop</a></h3>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Source code</h1>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
.
├── helloworld-java-app
└── terraform
    ├── modules
    │   ├── compute
    │   ├── db
    │   ├── instance-template
    │   ├── lb
    │   ├── network
    │   │   ├── bastion
    │   │   ├── subnet
    │   └── project
    ├── prod
    └── test
     </code></pre>
        <aside class="notes">
          <ul>
            <li>Java app</li>
            <li>Modules</li>
            <li>projects/environments</li>
          </ul>
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Task 1: Getting ready</h1>
        <ul>
          <li>Terraform admin project for the service account</li>
          <li>Remote state bucket</li>
        </ul>
        <aside class="notes">
          Using an Admin Project for your Terraform service account keeps the resources needed for managing your projects separate from the actual projects you create. While these resources could be created with Terraform using a service account from an existing project, in this tutorial you will create a separate project and service account exclusively for Terraform.
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Basis variables</h1>
        <p>Tip! Put the exports in <code>~/.gcp_env</code> and source it in <code>~/.bashrc</code></p>
        <pre>
        <code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
export GOOGLE_REGION=europe-west3 # change this if you want to use a different region
export TF_VAR_org_id=&lt;your_org_id&gt;
export TF_VAR_billing_account=&lt;your_billing_account_id&gt;
export TF_VAR_region=${GOOGLE_REGION}
export TF_VAR_user=${USER}
export TF_VAR_ssh_key=&lt;path_to_your_public_ssh_key&gt;
export TF_ADMIN=${USER}-tf-admin
export TF_CREDS=~/.config/gcloud/tf-admin.json
        </code>
        </pre>
        <p>Find the values for &lt;your_org_id&gt; and &lt;your_billing_account_id&gt;:</p>
        <pre>
        <code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
gcloud beta organizations list
gcloud alpha billing accounts list
        </code>
        </pre>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Create the Terraform service account</h1>
        <p>Create the service account and download the JSON credentials:</p>
        <pre>
        <code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
gcloud projects create ${TF_ADMIN} \
  --organization ${TF_VAR_org_id} \
  --set-as-default

gcloud alpha billing projects link ${TF_ADMIN} \
  --billing-account ${TF_VAR_billing_account}
        </code>
        </pre>
        <p>Grant permission to view the Admin Project and manage Cloud Storage:</p>
        <pre>
        <code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
gcloud projects add-iam-policy-binding ${TF_ADMIN} \
  --member serviceAccount:terraform@${TF_ADMIN}.iam.gserviceaccount.com \
  --role roles/viewer

gcloud projects add-iam-policy-binding ${TF_ADMIN} \
  --member serviceAccount:terraform@${TF_ADMIN}.iam.gserviceaccount.com \
  --role roles/storage.admin
        </code>
        </pre>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Enable APIs</h1>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
gcloud services enable cloudresourcemanager.googleapis.com
gcloud services enable cloudbilling.googleapis.com
gcloud services enable iam.googleapis.com
gcloud services enable compute.googleapis.com
        </code>
        </pre>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Remote state</h1>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
cd terraform/test

gsutil mb -l ${TF_VAR_region} -p ${TF_ADMIN} gs://${TF_ADMIN}

cat > backend.tf &lt;&lt;EOF
terraform {
 backend "gcs" {
   bucket = "${TF_ADMIN}"
   prefix  = "terraform/state/test"
 }
}
EOF        
        </code>
        </pre>
        <p>Initialize the backend</p>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
terraform init
        </code>
        </pre>
        <aside class="notes">
          Terraform must store state about your managed infrastructure and configuration. This state is used by Terraform to map real world resources to your configuration, keep track of metadata, and to improve performance for large infrastructures. This state is stored by default in a local file named "terraform.tfstate", but it can also be stored remotely, which works better in a team environment.
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>GCP provider and project</h1>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 800px;">
provider "google" {
 region = "${var.region}"
}

resource "random_id" "id" {
 byte_length = 4
 prefix      = "${var.name}-"
}

resource "google_project" "project" {
 name            = "${var.name}"
 project_id      = "${random_id.id.hex}"
 billing_account = "${var.billing_account}"
 org_id          = "${var.org_id}"
}

resource "google_project_services" "project" {
 project = "${google_project.project.project_id}"
 services = [
   "compute.googleapis.com"
 ]
}
        </code>
        </pre>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Create a module for it</h1>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
.
├── modules
│   └── project
│       ├── main.tf
├── prod
└── test
    ├── backend.tf
    ├── main.tf
    └── vars.tf
        </code>
        </pre>
        <pre class="fragment"><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
# main.tf
module "project" {
  source          = "../modules/project" # path to module
  name            = "hello-${var.env}"
  region          = "${var.region}"
  billing_account = "${var.billing_account}"
  org_id          = "${var.org_id}"
}
        </code>
        </pre>
        <pre class="fragment"><code data-trim contenteditable style="font-size: 18px; margin-top: 20px;">
# vars.tf
variable "env" { default = "test" }
variable "region" { default = "europe-west3" }
variable "billing_account" {}
variable "org_id" {}
        </code>
        </pre>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h3><code>terraform plan</code></h3>
        <pre class="fragment"><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 800px;">
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.

------------------------------------------------------------------------

Terraform will perform the following actions:

  + module.project.google_project.project
      id:                  &lt;computed&gt;
      billing_account:     "0000C2-2C8D36-F6184D"
      folder_id:           &lt;computed&gt;
      name:                "hello-test"
      number:              &lt;computed&gt;
      org_id:              "396389084239"
      policy_data:         &lt;computed&gt;
      policy_etag:         &lt;computed&gt;
      project_id:          "${random_id.id.hex}"
      skip_delete:         &lt;computed&gt;

  + module.project.google_project_services.project
      id:                  &lt;computed&gt;
      project:             "${google_project.project.project_id}"
      services.#:          "1"
      services.2240314979: "compute.googleapis.com"

  + module.project.random_id.id
      id:                  &lt;computed&gt;
      b64:                 &lt;computed&gt;
      b64_std:             &lt;computed&gt;
      b64_url:             &lt;computed&gt;
      byte_length:         "4"
      dec:                 &lt;computed&gt;
      hex:                 &lt;computed&gt;
      prefix:              "hello-test-"


Plan: 3 to add, 0 to change, 0 to destroy.
        </code>
        </pre>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h3><code>terraform apply</code></h3>
        <pre class="fragment"><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 800px;">
...
module.project.random_id.id: Creating...
  b64:         "" => "&lt;computed&gt;"
  b64_std:     "" => "&lt;computed&gt;"
  b64_url:     "" => "&lt;computed&gt;"
  byte_length: "" => "4"
  dec:         "" => "&lt;computed&gt;"
  hex:         "" => "&lt;computed&gt;"
  prefix:      "" => "hello-test-"
module.project.random_id.id: Creation complete after 0s (ID: 4r8CrQ)
module.project.google_project.project: Creating...
  billing_account: "" => "0000C2-2C8D36-F6184D"
  folder_id:       "" => "&lt;computed&gt;"
  name:            "" => "hello-test"
  number:          "" => "&lt;computed&gt;"
  org_id:          "" => "396389084239"
  policy_data:     "" => "&lt;computed&gt;"
  policy_etag:     "" => "&lt;computed&gt;"
  project_id:      "" => "hello-test-e2bf02ad"
  skip_delete:     "" => "&lt;computed&gt;"
module.project.google_project.project: Still creating... (10s elapsed)
module.project.google_project.project: Creation complete after 17s (ID: hello-test-e2bf02ad)
module.project.google_project_services.project: Creating...
  project:             "" => "hello-test-e2bf02ad"
  services.#:          "" => "1"
  services.2240314979: "" => "compute.googleapis.com"
module.project.google_project_services.project: Still creating... (10s elapsed)
...
module.project.google_project_services.project: Still creating... (1m30s elapsed)
module.project.google_project_services.project: Creation complete after 1m37s (ID: hello-test-e2bf02ad)

Apply complete! Resources: 3 added, 0 changed, 0 destroyed.
        </code>
        </pre>
        <aside class="notes">
        </aside>
      </section>

      <section style="width: 100%; height: 100%;">
        <h1>Profit &#128176;</h1>
        <img src="img/project_created.png">
        <aside class="notes">
        </aside>
      </section>


      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Networking and bastion host</h1>
        <img width="1198" src="img/gcp_networking.png">
        <aside class="notes">
          <ul>
            <li>Infrastructure repo contains basic infrastructure</li>
            <ul>
              <li>Networking</li>
              <li>Bastion host (jump server to get access to all the private servers)</li>
              <li>"Hardned" and just a ssh proxy</li>
            </ul>
          </ul>
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Network module</h1>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
modules/network/
├── vars.tf
├── main.tf
├── outputs.tf
├── bastion
│   ├── main.tf
│   ├── outputs.tf
│   └── vars.tf
├── subnet
│   ├── main.tf
│   ├── outputs.tf
│   └── vars.tf
       </code></pre>
        <pre class="fragment"><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">    
...
        
module "network" {
  source                     = "../modules/network"
  name                       = "${module.project.name}"
  project                    = "${module.project.id}"
  region                     = "${var.region}"
  zones                      = "${var.zones}"
  webservers_subnet_name     = "webservers"
  webservers_subnet_ip_range = "${var.webservers_subnet_ip_range}"
  bastion_image              = "${var.bastion_image}"
  bastion_instance_type      = "${var.bastion_instance_type}"
  user                       = "${var.user}"
  ssh_key                    = "${var.ssh_key}"
}
        </code></pre>
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 800px;">
# modules/network
# main.tf
resource "google_compute_network" "network" {
  name    = "${var.name}-network"
  project = "${var.project}"
}

resource "google_compute_firewall" "allow-ssh-from-everywhere-to-bastion" {
  name    = "${var.name}-allow-ssh-from-everywhere-to-bastion"
  project = "${var.project}"
  network = "${var.name}-network"

  allow {
    protocol = "tcp"
    ports    = ["22"]
  }

  source_ranges = ["0.0.0.0/0"]

  target_tags = ["bastion"]
}

resource "google_compute_firewall" "allow-ssh-from-bastion-to-webservers" {
  name               = "${var.name}-allow-ssh-from-bastion-to-webservers"
  project            = "${var.project}"
  network            = "${var.name}-network"
  direction          = "EGRESS"

  allow {
    protocol = "tcp"
    ports    = ["22"]
  }

  target_tags        = ["http"]
}

resource "google_compute_firewall" "allow-ssh-to-webservers-from-bastion" {
  name          = "${var.name}-allow-ssh-to-private-network-from-bastion"
  project       = "${var.project}"
  network       = "${var.name}-network"
  direction     = "INGRESS"

  allow {
    protocol = "tcp"
    ports    = ["22"]
  }

  source_tags   = ["bastion"]
}

resource "google_compute_firewall" "allow-http-to-appservers" {
  name          = "${var.name}-allow-http-to-appservers"
  project       = "${var.project}"
  network       = "${var.name}-network"

  allow {
    protocol = "tcp"
    ports    = ["80"]
  }

  source_ranges = ["0.0.0.0/0"]

  source_tags   = ["http"]
}

module "webservers_subnet" {
  source   = "./subnet"
  project  = "${var.project}"
  region   = "${var.region}"
  name     = "${var.webservers_subnet_name}"
  network  = "${google_compute_network.network.self_link}"
  ip_range = "${var.webservers_subnet_ip_range}"
}

module "bastion" {
  source        = "./bastion"
  name          = "${var.name}-bastion"
  project       = "${var.project}"
  zones         = "${var.zones}"
  image         = "${var.bastion_image}"
  instance_type = "${var.bastion_instance_type}"
  user          = "${var.user}"
  ssh_key       = "${var.ssh_key}"
}

---

# vars.tf
variable "name" {}
variable "project" {}
variable "region" {}
variable "zones" { type = "list" }
variable "webservers_subnet_name" {}
variable "webservers_subnet_ip_range" {}
variable "bastion_image" {}
variable "bastion_instance_type" {}
variable "user" {}
variable "ssh_key" {}

---

# outputs.tf
output "name" {
  value = "${google_compute_network.network.name}"
}
output "bastion_public_ip" {
  value = "${module.bastion.public_ip}"
}
output "gateway_ipv4"  {
  value = "${google_compute_network.network.gateway_ipv4}"
}
     </code></pre>
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 800px;">
# modules/network/subnet
# main.tf
resource "google_compute_subnetwork" "subnet" {
  name          = "${var.name}"
  project       = "${var.project}"
  region        = "${var.region}"
  network       = "${var.network}"
  ip_cidr_range = "${var.ip_range}"
}

---

# vars.tf
variable "name" {}
variable "project" {}
variable "region" {}
variable "network" {}
variable "ip_range" {}

---

# outputs.tf
output "ip_range" {
  value = "${google_compute_subnetwork.subnet.ip_cidr_range}"
}
output "self_link" {
  value = "${google_compute_subnetwork.subnet.self_link}"
}
     </code></pre>
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 800px;">
# modules/network/bastion
# main.tf
resource "google_compute_instance" "bastion" {
  name         = "${var.name}"
  project      = "${var.project}"
  machine_type = "${var.instance_type}"
  zone         = "${element(var.zones, 0)}"

  metadata {
    ssh-keys = "${var.user}:${file("${var.ssh_key}")}"
  }

  boot_disk {
    initialize_params {
      image = "${var.image}"
    }
  }

  network_interface {
    subnetwork = "${var.subnet_name}"

    access_config {
      # Ephemeral IP - leaving this block empty will generate a new external IP and assign it to the machine
    }
  }

  tags = ["bastion"]
}

---

# vars.tf
variable "name" {}
variable "project" {}
variable "zones" { type = "list" }
variable "subnet_name" {}
variable "image" {}
variable "instance_type" {}
variable "user" {}
variable "ssh_key" {}

---

# outputs.tf
output "private_ip" {
  value = "${google_compute_instance.bastion.network_interface.0.address}"
}
output "public_ip" {
  value = "${google_compute_instance.bastion.network_interface.0.access_config.0.assigned_nat_ip}"
}
     </code></pre>
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Profit &#128176;</h1>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 800px;">
ssh -i ~/.ssh/id_rsa $USER@$(terraform output --module=network bastion_public_ip)
[steinim@hello-test-bastion ~]$
        </code></pre>
        <img src="img/bastion_created.png">
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Next: Instance template</h1>
        <img width="1198" src="img/gcp_instance_template.png">
        <aside class="notes">
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Instance template module</h1>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
modules/instance-template
├── main.tf
├── outputs.tf
├── scripts
│   └── startup.sh
└── vars.tf
        </code></pre>
        <pre class="fragment"><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
# main.tf
...

module "instance-template" {
  source        = "../modules/instance-template"
  name          = "${module.project.name}"
  env           = "${var.env}"
  project       = "${module.project.id}"
  region        = "${var.region}"
  network_name  = "${module.network.name}"
  image         = "${var.app_image}"
  instance_type = "${var.app_instance_type}"
  user          = "${var.user}"
  ssh_key       = "${var.ssh_key}"

---

# vars.tf

...

variable "appserver_count" { default = 2 }
variable "app_image" { default = "centos-7-v20170918" }
variable "app_instance_type" { default = "f1-micro" }
        </code></pre>
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 800px;">
# main.tf
resource "google_compute_instance_template" "webserver" {
  name         = "${var.name}-webserver-instance-template"
  project      = "${var.project}"
  machine_type = "${var.instance_type}"
  region       = "${var.region}"

  metadata {
    ssh-keys = "${var.user}:${file("${var.ssh_key}")}"
  }

  disk {
    source_image = "${var.image}"
    auto_delete  = true
    boot         = true
  }

  network_interface {
    network            = "${var.network_name}"
    access_config {
      # Ephemeral IP - leaving this block empty will generate a new external IP and assign it to the machine
    }
  }

  metadata_startup_script = "${file("${path.module}/scripts/startup.sh")}"

  tags = ["http"]

  labels = {
    environment = "${var.env}"
  }
}

---

# vars.tf

variable "name" {}
variable "project" {}
variable "network_name" {}
variable "image" {}
variable "instance_type" {}
variable "user" {}
variable "ssh_key" {}
variable "env" {}
variable "region" {}

---

# outputs.tf

output "instance_template" {
  value = "${google_compute_instance_template.webserver.self_link}"
}

---

# scripts/startup.sh
#!/bin/bash

yum install -y nginx java

cat <<'EOF' > /etc/nginx/nginx.conf
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    server {
        listen      80 default_server;
        server_name _;
        location / {
            proxy_pass  http://127.0.0.1:1234;
        }
    }
}
EOF

setsebool -P httpd_can_network_connect true

systemctl enable nginx
systemctl start nginx

curl -o app.jar https://morisbak.net/files/devops.jar

java -jar app.jar > /dev/null 2>&1 &

     </code></pre>
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Profit &#128176;</h1>
        <img src="img/instance_template_created.png">
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Auto scaling and load balancing</h1>
        <img src="img/gcp_auto_scaling.png">
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>&#128560; What you'll need &#128560;</h1>
        <ul>
          <li class="fragment">google_compute_global_forwarding_rule</li>
          <li class="fragment">google_compute_target_http_proxy</li>
          <li class="fragment">google_compute_url_map</li>
          <li class="fragment">google_compute_backend_service</li>
          <li class="fragment">google_compute_http_health_check</li>
          <li class="fragment">google_compute_instance_group_manager</li>
          <li class="fragment">google_compute_target_pool</li>
          <li class="fragment">google_compute_instance_group</li>
          <li class="fragment">google_compute_autoscaler</li>
        </ul>
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Load balancer module</h1>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
modules/lb
├── main.tf
└── vars.tf
        </code></pre>
        <pre class="fragment"><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
# main.tf

...

module "lb" {
  source            = "../modules/lb"
  name              = "${module.project.name}"
  project           = "${module.project.id}"
  region            = "${var.region}"
  count             = "${var.appserver_count}"
  instance_template = "${module.instance-template.instance_template}"
  zones             = "${var.zones}"
}
        </code></pre>
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 800px;">
# main.tf
resource "google_compute_global_forwarding_rule" "global_forwarding_rule" {
  name       = "${var.name}-global-forwarding-rule"
  project    = "${var.project}"
  target     = "${google_compute_target_http_proxy.target_http_proxy.self_link}"
  port_range = "80"
}

resource "google_compute_target_http_proxy" "target_http_proxy" {
  name        = "${var.name}-proxy"
  project     = "${var.project}"
  url_map     = "${google_compute_url_map.url_map.self_link}"
}

resource "google_compute_url_map" "url_map" {
  name            = "${var.name}-url-map"
  project         = "${var.project}"
  default_service = "${google_compute_backend_service.backend_service.self_link}"
}

resource "google_compute_backend_service" "backend_service" {
  name                  = "${var.name}-backend-service"
  project               = "${var.project}"
  port_name             = "http"
  protocol              = "HTTP"
  backend {
    group                 = "${element(google_compute_instance_group_manager.webservers.*.instance_group, 0)}"
    balancing_mode        = "RATE"
    max_rate_per_instance = 100
  }

  backend {
    group                 = "${element(google_compute_instance_group_manager.webservers.*.instance_group, 1)}"
    balancing_mode        = "RATE"
    max_rate_per_instance = 100
  }

  health_checks = ["${google_compute_http_health_check.healthcheck.self_link}"]
}

resource "google_compute_http_health_check" "healthcheck" {
  name         = "${var.name}-healthcheck"
  project      = "${var.project}"
  port         = 80
  request_path = "/"
}

resource "google_compute_instance_group_manager" "webservers" {
  name               = "${var.name}-instance-group-manager-${count.index}"
  project            = "${var.project}"
  instance_template  = "${var.instance_template}"
  base_instance_name = "${var.name}-webserver-instance"
  count              = "${var.count}"
  zone               = "${element(var.zones, count.index)}"
  named_port {
    name = "http"
    port = 80
  }
}

resource "google_compute_autoscaler" "autoscaler" {
  name    = "${var.name}-scaler-${count.index}"
  project = "${var.project}"
  count   = "${var.count}"
  zone    = "${element(var.zones, count.index)}"
  target  = "${element(google_compute_instance_group_manager.webservers.*.self_link, count.index)}"

  autoscaling_policy = {
    max_replicas    = 3
    min_replicas    = 1
    cooldown_period = 60

    cpu_utilization {
      target = 0.6
    }
  }
}

---

# vars.tf

variable "name" {}
variable "project" {}
variable "region" {}
variable "count" {}
variable "instance_template" {}
variable "zones" { type = "list" }
     </code></pre>
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Profit &#128176;</h1>
        <h2>Jump through bastion</h2>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 800px;">
ssh -J $USER@$(terraform output --module=network bastion_public_ip) $USER@10.156.0.3
[steinim@hello-test-webserver-instance-hr80 ~]$
        </code></pre>
        <h2>Load balancer created</h2>
        <img src="img/lb_created.png">
        <h1>and ... &#127881;</h1>
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>
          <div style="background-color: rgba(0, 0, 0, 0.4);">&#128176; &#128640;&#128640;&#128640;&#128640; &#128176;</div>
        </h1>
        <img src="img/hello.png">
        <aside class="notes">
        </aside>
      </section>



      <!--

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>Tools</h1>
        <img width="235" height="235" src="img/toolbox.png" alt="Verktøykasse">
        <p style="font-size: 28px;">&nbsp;</p>
        <p style="font-size: 28px;">&nbsp;</p>
        <aside class="notes">Let's look at tools we use to automate, simplify and secure infrastructure and applications.</aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h2>Passwords, secrets and keys in an automated pipeline</h2>
        <img width="235" height="235" src="img/padlock.png" alt="Padlock">
        <p style="font-size: 28px;">&nbsp;</p>
        <p style="font-size: 28px;">&nbsp;</p>
        <aside class="notes">
          <ul>
            <li>In the examples we have seen some secret variables</li>
            <li>To automate insertion of secrets we have put together some tools</li>
          </ul>
        </aside>
      </section>

      <section data-background-image="img/nsb_cloud-tools.png">
        <aside class="notes">
          <ul>
            <li>We have created a wrapper around Terraform to manage just that</li>
          </ul>
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h2><code>cloud-config.yml</code></h2>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
vars:
  - name: AWS_DEFAULT_REGION
    value: eu-central-1

  - name: TF_VAR_env
    value: prod

  - name: TF_VAR_vpc_name
    value: prod

  - name: TF_VAR_public_key
    value: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCzwGCC+nMTL6QIg+Z7SXtIXhiJJ5caa5tZkWQ1E6jDgHp7NqDAb21ZzjK3mGFlugF81h3OBF8uZPE5E+A0mRCB/pMzEMi/SBv0nvuPhijT81OeJxiF11Zxejc6gk8YiJIywQcYD3OcmmWvP2gK7MU1VIf3SQjHEROMaz+4uNJlC6QpDJfepxevQVJ4GVk7uq71NJjXV91gyT4/smOz5dP6tT7dYuP5Zn3lr5VN/BmHmtpklK9AWhwoIyRi+t97T1ihgiDvrmg7QSH9hIM+zKH2oxWi0RGV99t+ac6DV54ys4XD7OLAhHdlL7qV2G1TSIFqXXOaV98Cj2Mkxd2vJhhZ"

secret-vars:
  - name: TF_VAR_db_root_password
    key: nsb/aws/nsbno/prod/db_root_password

  - name: TF_VAR_private_key
    key: nsb/aws/nsb.pem

     </code></pre>
        <div class="mb-frame fragment" style="width: 480px; height: 175px; right: 750px; top: 400px;"></div>
        <aside class="notes">
          <ul>
            <li>The wrapper expects a file called cloud-config.yml</li>
            <li>What it does is to handle variables in different ways. Some plain, some secret and som dynamic.</li>
            <li>vars: why do they start with TF_VAR?</li>
            <li>Secret vars uses passwordstore, commandline tool for encrypting secrets</li>
            <li>Let's have a look at secret variables first, but first I will introduce a nice tool we use for secrets.</li>
          </ul>
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <img src="img/pass.png" alt="passwordstore">
        <aside class="notes">
          <ul>
            <li>pass is a commandline tool for password management</li>
            <li>an alternative tool to pass is git-crypt.
          </ul>
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h2><code>pass</code></h2>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
~/src/nsb/.password-store
├── nsb.pem.gpg
├── nsbno
│   ├── prod
│   │   ├── bucket_user_secret_key.gpg
│   │   ├── db_password.gpg
│   │   └── vault_password.gpg
│   ├── test1
│   │   ├── ...
├── push
│   ├── prod
│   │   ├── ...
│   └── test1
│       ├── ...
├── nexus
│   └── users
│       ├── admin.gpg
│       └── deployment.gpg
├── ...
│   ├── maven
│       └── settings.xml.gpg
│   └── travis
│       └── nsbno-buildserver.gpg
├── enonic
│      └── cms.licenseKey.gpg
...
     </code></pre>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
✗ pass show -c nsbno/prod/db_password
     </code></pre>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-width: 900px; ">
┌────────────────────────────────────────────────────────────────────────────────────┐
│ Please enter the passphrase to unlock the secret key for the OpenPGP certificate:  │
│ "Stein Inge Morisbak &lt;stein.inge.morisbak@BEKK.no&gt;"                                │
│ 2048-bit RSA key, ID 38380D80,                                                     │
│ created 2014-05-15 (main key ID 0CB573BF).                                         │
│                                                                                    │
│                                                                                    │
│ Passphrase ***********____________________________________________________________ │
│                                                                                    │
│            &lt;OK&gt;                                                  &lt;Cancel&gt;          │
└────────────────────────────────────────────────────────────────────────────────────┘
     </code></pre>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
✗ pass show -c nsbno/prod/db_password
Copied nsbno/prod/db_password to clipboard. Will clear in 45 seconds.
     </code></pre>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h2><code>envchain</code></h2>
        <img src="img/envchain.png" alt="envchain">
        <aside class="notes">
          <ul>
            <li>Uses MacOs keychain</li>
          </ul>
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
✗ envchain --set aws AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY
aws.AWS_ACCESS_KEY_ID: AKIAXXXXXXXXXXXXXXXX
aws.AWS_SECRET_ACCESS_KEY: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
     </code></pre>

        <pre class="fragment"><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
✗ envchain aws env | grep AWS_
AWS_ACCESS_KEY_ID=AKIAXXXXXXXXXXXXXXXX
AWS_SECRET_ACCESS_KEY=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
     </code></pre>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
✗ envchain aws terraform-wrapper apply
     </code></pre>
        <pre class="fragment"><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
You are provisioning PROD. Type PROD to continue... PROD
     </code></pre>

        <pre class="fragment"><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
Started terraform operation at: 2017-09-08 12:46:57.870942455 +0200 CEST m=+6.052644916

null_resource.upload_efs_backup_script: Refreshing state... (ID: 8456414560025152219)
aws_route53_record.environment_route53_record: Refreshing state... (ID: Z1FHZIDFG100FA_prod.cloud.nsb.no_CNAME)
aws_route53_record.environment_route53_record: Refreshing state... (ID: Z1FHZIDFG100FA_app1.cloud.nsb.no_CNAME)
aws_route53_record.environment_route53_record: Refreshing state... (ID: Z1FHZIDFG100FA_app1.prod.cloud.nsb.no_CNAME)
aws_security_group.app_security_group: Refreshing state... (ID: sg-5f731534)
aws_security_group.efs_backup_security_group: Refreshing state... (ID: sg-279d864c)
aws_route53_record.environment_route53_record: Refreshing state... (ID: Z1FHZIDFG100FA_cloud.nsb.no_A)
aws_security_group.efs_security_group: Refreshing state... (ID: sg-a43d30cf)
aws_iam_user.user: Refreshing state... (ID: nsbno-prod)
aws_iam_role.role: Refreshing state... (ID: prod-nsbno-s3-full-access)
aws_iam_policy.policy: Refreshing state... (ID: arn:aws:iam::635004941268:policy/AmazonS3FullAccess-ElasticBeanstalk-NSBNO-prod)
aws_security_group.db_sg: Refreshing state... (ID: sg-817214ea)
aws_efs_file_system.efs: Refreshing state... (ID: fs-985cb8c1)
...
Apply complete! Resources: 0 added, 0 changed, 0 destroyed.
     </code></pre>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>SaaS</h1>
        <h2><code>./app-infrastructure</code></h2>
        <ul>
          <li>RDS - Relational Database Service</li>
          <li>Route53 (DNS)</li>
          <li>Certificate Manager (SSL/TLS certificates)</li>
          <li>EFS - Elastic File System (NFS)</li>
          <li>S3 (Scalable storage)</li>
          <li>CloudWatch (monitoring, events, logs)</li>
          <li>CloudTrail (audit)</li>
          <li>IAM (Identity &amp; Access Management)</li>
        </ul>
        <aside class="notes">
          <ul>
            <li>The app-infrastructure-repo has all setup of services that are common to most applications.</li>
            <ul>
              <li>RDS - Relational Database Service</li>
              <li>Route53 (DNS)</li>
              <li>Certificate Manager (SSL/TLS certificates)</li>
              <li>EFS - Elastic File System (NFS)</li>
              <li>S3 (Scalable storage)</li>
              <li>CloudWatch (monitoring, events, logs)</li>
              <li>CloudTrail (audit)</li>
              <li>IAM (Identity &amp; Access Management)</li>
            </ul>
            <li>Common for all of these is that you don't need to think about operating them.</li>
            <li>Backup (except EFS), mirroring, patching, scaling and so on is handled by AWS</li>
          </ul>
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h2>Layout</h2>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
./app-infrastructure
└── modules
    ├── database
    │   ├── main.tf
    │   ├── outputs.tf
    │   └── vars.tf
    ├── efs
    │   ├── main.tf
    │   ├── outputs.tf
    │   └── vars.tf
    ├── route53_alias_record
    │   ├── main.tf
    │   └── vars.tf
    ├── route53_cname_record
    │   ├── main.tf
    │   └── vars.tf
    └── ssl_cert
        ├── main.tf
        ├── outputs.tf
        └── vars.tf
     </code></pre>
        <aside class="notes"></aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
resource "aws_db_instance" "db" {
  name                    = "${var.db_name}"
  identifier              = "${var.db_identifier}"
  engine                  = "${var.db_engine}"
  engine_version          = "${var.db_engine_version}"
  instance_class          = "${var.db_instance_class}"
  username                = "${var.db_username}"
  password                = "${var.db_password}"
  vpc_security_group_ids  = ["${aws_security_group.db_sg.id}"]
  db_subnet_group_name    = "${var.db_subnet_group_id}"
  parameter_group_name    = "${var.db_parameter_group_name}"
  backup_retention_period = "${var.backup_retention_period}"
  availability_zone       = "${var.availability_zone}"
  multi_az                = "${var.multi_az}"
  backup_window           = "${var.backup_window}"
  maintenance_window      = "${var.maintenance_window}"
  allocated_storage       = "${var.allocated_storage}"
  storage_type            = "${var.storage_type}"
  apply_immediately       = "${var.apply_immediately}"
  skip_final_snapshot     = "${var.skip_final_snapshot}"
}

resource "aws_security_group" "db_sg" {
    vpc_id      = "${var.vpc_id}"
    name        = "${var.db_sg_name}"
    description = "${var.db_sg_name}"
    tags { Name = "${var.db_sg_name}" }
}
     </code></pre>
        <aside class="notes">
          <ul>
            <li>Can be reused across database platforms</li>
            <li>We use both MySQL and Postgres.</li>
            <li>Amazon RDS manages backups, software patching, automatic failure detection, and recovery.</li>
            <li>Multi AZ: Standby in another availability zone</li>
          </ul>
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <img src="img/db.png" alt="Subnets">
        <aside class="notes">
          <ul>
            <li>DB</li>
          </ul>
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>AWS CLI</h1>
        <pre><code data-trim contenteditable style="font-size: 18px; margin-top: 20px; max-height: 1000px;">
NAME
       aws -

DESCRIPTION
       The  AWS  Command  Line  Interface is a unified tool to manage your AWS
       services.

SYNOPSIS
          aws [options] &lt;command&gt; &lt;subcommand&gt; [parameters]

       Use aws command help for information on a  specific  command.  Use  aws
       help  topics  to view a list of available help topics. The synopsis for
       each command shows its parameters and their usage. Optional  parameters
       are shown in square brackets.
     </code></pre>
        <aside class="notes">
          <ul>
            <li>We use the aws command line client extensively</li>
            <li>We want to fiddle in the GUI as little as possible and it's excellent for scripting.</li>
          </ul>
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>PaaS</h1>
        <h2><code>{./app1,./app2,...}</code></h2>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" style="width: 100%; height: 100%;">
        <h1>From pets to cattle</h1>
        <p>&nbsp;</p>
        <img style="float: left; position: relative; display:inline-block; left: 10%;" width="300" src="img/luke_og_leia.png">
        <div style="display:inline-block;">
          <p style="float: none; position: relative; right: 30%;">&#8663;</p>
          <p style="float: none; position: relative; right: 30%;">&rArr;</p>
          <p style="float: none; position: relative; right: 30%;">&#8664;</p>
        </div>
        <img style="float: right; position: relative; right: 10%;" width="300" src="img/cattle.jpg">
        <footer class="layer right" style="font-size: 25px; position: relative; left: 30%; bottom: 0%; background-color: rgba(0, 0, 0, 0);">"When one of'em gets sick I just shoot'em in the head"</footer>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-image="img/didnt_mention.jpg">
        <div class="layer" style="background-color: rgba(0, 0, 0, 0.3);">
          <h1>What didn't I mention?</h1>
          <ul>
            <li><b>Application level security</b></li>
            <li><b>Security culture</b></li>
            <li>Stuff I forgot about</li>
          </ul>
        </div>
        <aside class="notes">
          <ul>
            <li></li>
          </ul>
        </aside>
      </section>

      <section data-background-image="img/other_services2.png">
        <div class="layer" style="background-color: rgba(0, 0, 0, 0.5);">
          <h1>Other services we use</h1>
          <ul>
            <li>Panopticon (internal monitoring)</li>
            <li>Auth0 (authentication)</li>
            <li>Pingdom (external monitoring)</li>
            <li>Pagerduty (paging us when we're on duty)</li>
            <li>Slack (ChatOps)</li>
            <li>Github (for everything!)</li>
            <li>Travis (CI)</li>
            <li>Ansible (configuration management)</li>
            <li>Lambdas and SNS for posting events to Slack</li>
          </ul>
        </div>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-image="img/summing_it_up.png">
        <h1 style="background-color: rgba(0, 0, 0, 0.7);">Summing it up</h1>
        <aside class="notes">
          <ul>
            <li>I have been talking a lot. And it's been quite technical too.</li>
            <li>How do we put all this together?</li>
          </ul>
        </aside>
      </section>

      <section data-background-image="img/anger.jpg">
        <div style="background-color: rgba(0, 0, 0, 0.6);">
          <h1>What did we learn?</h1>
          <ol>
            <li class="fragment">Reduce IaaS to a bare minimum</li>
            <li class="fragment">Use hosted services where available (SaaS)</li>
            <li class="fragment">Use PaaS for services and applications</li>
            <li class="fragment">Automate, Automate, Automate... </li>
            <li class="fragment">Monitor, Monitor, Monitor... </li>
            <li class="fragment"><b>Migration of existing services is the hard part</b></li>
          </ol>
        </div>
        <aside class="notes"> </aside>
      </section>

      <section data-background-image="img/climbing_to_the_top.jpg">
        <div style="background-color: rgba(0, 0, 0, 0.4);">
          <h1>What did we gain?</h1>
          <ol>
            <li class="fragment">Security we can understand</li>
            <li class="fragment">Insight in everything</li>
            <li class="fragment">The hard parts is the cloud vendors responsibility</li>
            <li class="fragment">Prod.-equal environments on demand</li>
            <li class="fragment">Elasticity and auto scaling</li>
            <li class="fragment">Reduced lead time</li>
            <li class="fragment">Agile business development</li>
            <li class="fragment">Ownership of what's delivered</li>
            <li class="fragment">Responsibility in the right place</li>
            <li class="fragment">Less stuff to remember</li>
            <li class="fragment">Happy employees :-D</li>
          </ol>
        </div>
        <aside class="notes">
        </aside>
      </section>

      <section data-background-image="img/future.jpg">
        <div style="background-color: rgba(0, 0, 0, 0.7);">
          <h1>Plans for the future</h1>
          <ul>
            <li class="fragment">Rewrite "lift and shift" applications to "cloud native"</li>
            <li class="fragment">Microservices is a perfect match for what NSB wants to achieve</li>
            <li class="fragment">More #Serverless (a.o. replace most of mgmtserver responsibilities)</li>
          </ul>
        </div>
        <aside class="notes">
          <ul>
            <li></li>
          </ul>
        </aside>
      </section>

-->

      <section data-background-video="../video/bekk.no-background.mp4" data-background-video-loop="true" data-background="rgb(23, 22, 23)" style="width: 100%; height: 100%;">
        <h2>Thank you!</h2>
        <p>Slides:<br><a href="http://steinim.github.io/slides/terraform-on-gcp/">http://steinim.github.io/slides/terraform-on-gcp/</a></p>
        <p>Workshop:<br><a href="https://github.com/steinim/gcp-terraform-workshop">https://github.com/steinim/gcp-terraform-workshop</a></p>
        <img width="252" height="235" src="../img/me_bart.png" alt="Stein Inge Morisbak">
        <p><a href="https://twitter.com/steinim">@steinim</a></p>
        <p><a href="mailto:stein.inge.morisbak@BEKK.no">stein.inge.morisbak@BEKK.no</a></p>
        <aside class="notes">
          Remember to give feedback
        </aside>
      </section>

    </div>
  </div>
  <script src="../lib/js/head.min.js"></script>
  <script src="../js/reveal.min.js"></script>

  <script>
    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
      controls: false,
      progress: true,
      history: true,
      center: true,
      width: 1280,
      height: 960,

      theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
      transition: Reveal.getQueryHash().transition || 'none', // default/cube/page/concave/zoom/linear/fade/none

      // Optional libraries used to extend on reveal.js
      dependencies: [{
          src: '../lib/js/classList.js',
          condition: function() {
            return !document.body.classList;
          }
        },
        {
          src: '../plugin/markdown/marked.js',
          condition: function() {
            return !!document.querySelector('[data-markdown]');
          }
        },
        {
          src: '../plugin/markdown/markdown.js',
          condition: function() {
            return !!document.querySelector('[data-markdown]');
          }
        },
        {
          src: '../plugin/highlight/highlight.js',
          async: true,
          callback: function() {
            hljs.initHighlightingOnLoad();
          }
        },
        {
          src: '../plugin/zoom-js/zoom.js',
          async: true,
          condition: function() {
            return !!document.body.classList;
          }
        },
        {
          src: 'plugin/notes/notes.js',
          async: true,
          condition: function() {
            return !!document.body.classList;
          }
        }
        // { src: '../plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
        // { src: '../plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
      ]
    });

  </script>

</body>

</html>
